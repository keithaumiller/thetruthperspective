<?php

/**
 * @file  testing2
 * News Extractor module - Extracts full article content using Diffbot API and generates AI summaries.
 */

use Drupal\node\Entity\Node;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\Entity\EntityFormDisplay;
use Drupal\Core\Logger\LoggerChannelFactoryInterface;

/**
 * Implements hook_feeds_process_alter().
 * 
 * Alter feed item data before it becomes a node. 
 */
function news_extractor_feeds_process_alter(&$feed, $item, $entity_interface) {
  // Check if this is an article feed
  if ($entity_interface->getTarget()->bundle() == 'article') {
    
    // Filter out specific domains in the link
    if (!empty($item['link'])) {
      $blocked_domains = [
        'comparecards.com',
        'fool.com',
        'lendingtree.com',
      ];
      
      foreach ($blocked_domains as $domain) {
        if (strpos($item['link'], $domain) !== FALSE) {
          \Drupal::logger('news_extractor')->info('Skipping blocked domain in link: @url', [
            '@url' => $item['link'],
          ]);
          $feed->skipItem($item);
          return;
        }
      }
    }

    // Filter out specific domains in the title
    if (!empty($item['title'])) {
      $blocked_domains = [
        'comparecards.com',
        'fool.com',
        'lendingtree.com',
      ];
      foreach ($blocked_domains as $domain) {
        if (strpos(strtolower($item['title']), strtolower($domain)) !== FALSE) {
          \Drupal::logger('news_extractor')->info('Skipping blocked domain in title: @title', [
            '@title' => $item['title'],
          ]);
          $feed->skipItem($item);
          return;
        }
      }
    }
    
    // Handle missing or empty titles
    if (empty($item['title']) || trim($item['title']) == '') {
      if (!empty($item['description'])) {
        // Use first 60 characters of description as title
        $description = strip_tags($item['description']);
        $description = trim($description);
        $fallback_title = substr($description, 0, 60);

        // Add ellipsis if we truncated
        if (strlen($description) > 60) {
          $fallback_title .= '...';
        }

        // Truncate to 255 characters for DB safety
        $fallback_title = substr($fallback_title, 0, 255);

        // Check blocked domains in fallback title
        $blocked_domains = [
          'comparecards.com',
          'fool.com',
          'lendingtree.com',
        ];
        foreach ($blocked_domains as $domain) {
          if (strpos(strtolower($fallback_title), strtolower($domain)) !== FALSE) {
            \Drupal::logger('news_extractor')->info('Skipping blocked domain in fallback title: @title', [
              '@title' => $fallback_title,
            ]);
            $feed->skipItem($item);
            return;
          }
        }

        $item['title'] = $fallback_title;

        \Drupal::logger('news_extractor')->info('Created fallback title: @title', [
          '@title' => $fallback_title,
        ]);
      } else if (!empty($item['link'])) {
        // Use link as fallback title, but check length and blocked domains
        $fallback_title = substr($item['link'], 0, 255);

        $blocked_domains = [
          'comparecards.com',
          'fool.com',
          'lendingtree.com',
        ];
        foreach ($blocked_domains as $domain) {
          if (strpos(strtolower($fallback_title), strtolower($domain)) !== FALSE) {
            \Drupal::logger('news_extractor')->info('Skipping blocked domain in fallback link title: @title', [
              '@title' => $fallback_title,
            ]);
            $feed->skipItem($item);
            return;
          }
        }

        $item['title'] = $fallback_title;

        \Drupal::logger('news_extractor')->info('Created fallback title from link: @title', [
          '@title' => $fallback_title,
        ]);
      } else {
        // No title, description, or link - skip this item
        \Drupal::logger('news_extractor')->info('Skipping item with no title, description, or link.');
        $feed->skipItem($item);
        return;
      }
    }
    
    // Skip items with very short titles (even after fallback)
    if (strlen(trim($item['title'])) < 10) {
      \Drupal::logger('news_extractor')->info('Skipping item with very short title: @title', [
        '@title' => $item['title'],
      ]);
      $feed->skipItem($item);
      return;
    }
    
    // Skip non-article URLs (your existing URL filtering)
    if (!empty($item['link']) && !_news_extractor_is_article_url($item['link'])) {
      \Drupal::logger('news_extractor')->info('Skipping non-article URL: @url', [
        '@url' => $item['link'],
      ]);
      $feed->skipItem($item);
      return;
    }
  }
}

/**
 * Implements hook_ENTITY_TYPE_insert().
 *
 * Automatically extract full article content when a new article is created via feeds.
 */
function news_extractor_node_insert(EntityInterface $entity) {
  // Only process Article content type
  if ($entity->bundle() == 'article') {
    // Check if this article has an Original URL field
    if ($entity->hasField('field_original_url') && !$entity->get('field_original_url')->isEmpty()) {
      $original_url = $entity->get('field_original_url')->uri;
      
      // Check if URL is actually an article before processing
      if (!_news_extractor_is_article_url($original_url)) {
        \Drupal::logger('news_extractor')->info('Deleting non-article content: @title (@url)', [
          '@title' => $entity->getTitle(),
          '@url' => $original_url,
        ]);
        $entity->delete();
        return;
      }
      
      // Only extract if Body field is empty or contains only summary
      $body = $entity->get('body')->value;
      if (empty($body) || strlen($body) < 500) {
        _news_extractor_extract_content($entity, $original_url);
      }
    }
  }
}

/**
 * Implements hook_ENTITY_TYPE_update().
 *
 * Extract content when article is updated with new URL.
 */
function news_extractor_node_update(EntityInterface $entity) {
  // Only process Article content type
  if ($entity->bundle() == 'article') {
    // Check if Original URL field was updated
    if ($entity->hasField('field_original_url') && !$entity->get('field_original_url')->isEmpty()) {
      $original_url = $entity->get('field_original_url')->uri;
      $original_entity = $entity->original;
      
      // Check if URL changed
      if (!$original_entity->get('field_original_url')->isEmpty()) {
        $old_url = $original_entity->get('field_original_url')->uri;
        if ($original_url != $old_url) {
          _news_extractor_extract_content($entity, $original_url);
        }
      }
    }
  }
}

/**
 * Check if URL is likely a news article (not podcast, video, ad, etc.).
 *
 * @param string $url
 *   The URL to check.
 *
 * @return bool
 *   TRUE if URL appears to be an article, FALSE otherwise.
 */
function _news_extractor_is_article_url($url) {
  // First check blocked domains
  $blocked_domains = [
    'comparecards.com',
    'fool.com',
  ];
  
  foreach ($blocked_domains as $domain) {
    if (strpos($url, $domain) !== FALSE) {
      return FALSE;
    }
  }
  
  // Skip patterns that are definitely not articles
  $skip_patterns = [
    '/audio/',
    '/video/',
    '/podcast/',
    '/gallery/',
    '/interactive/',
    '/live-news/',
    '/live-tv/',
    '/newsletters/',
    '/sponsored/',
    '/advertisement/',
    '/ads/',
    '/promo/',
    '/newsletter/',
    '/weather/',
    '/specials/',
    '/cnn-underscored/',
    '/coupons/',
    '/profiles/',
  ];
  
  // Check for skip patterns
  foreach ($skip_patterns as $pattern) {
    if (strpos($url, $pattern) !== FALSE) {
      \Drupal::logger('news_extractor')->info('Skipping non-article URL: @url (matched pattern: @pattern)', [
        '@url' => $url,
        '@pattern' => $pattern,
      ]);
      return FALSE;
    }
  }
  
  // Additional checks for ad-related URLs
  $ad_keywords = ['sponsored', 'advertisement', 'promo', 'ad-', '-ad', 'coupon'];
  $url_lower = strtolower($url);
  
  foreach ($ad_keywords as $keyword) {
    if (strpos($url_lower, $keyword) !== FALSE) {
      \Drupal::logger('news_extractor')->info('Skipping ad-related URL: @url (matched keyword: @keyword)', [
        '@url' => $url,
        '@keyword' => $keyword,
      ]);
      return FALSE;
    }
  }
  
  // Check for URLs that look like article paths
  $article_patterns = [
    '/politics/',
    '/world/',
    '/us/',
    '/national/',
    '/international/',
    '/breaking/',
    '/news/',
  ];
  
  foreach ($article_patterns as $pattern) {
    if (strpos($url, $pattern) !== FALSE) {
      return TRUE;
    }
  }
  
  // Default: allow URLs that end with common article patterns
  if (preg_match('/\/(index\.html?|story\.html?)$/i', $url) || 
      preg_match('/\/\d{4}\/\d{2}\/\d{2}\//', $url)) {
    return TRUE;
  }
  
  // Log URLs we're unsure about
  \Drupal::logger('news_extractor')->info('Uncertain about URL, allowing: @url', [
    '@url' => $url,
  ]);
  
  return TRUE; // When in doubt, allow it
}

/**
 * Extract full article content using Diffbot API.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   The article node entity.
 * @param string $url
 *   The original article URL.
 */
function _news_extractor_extract_content(EntityInterface $entity, $url) {
  // Diffbot API configuration
  $api_token = '8488710a556cedc9ff2ad6547bbbecaf';
  $api_url = 'https://api.diffbot.com/v3/article';
  
  // Build API request URL
  $request_url = $api_url . '?' . http_build_query([
    'token' => $api_token,
    'url' => $url,
    'paging' => 'false', // Don't paginate long articles
  ]);
  
  try {
    // Make API request
    $response = \Drupal::httpClient()->get($request_url, [
      'timeout' => 30,
      'headers' => [
        'Accept' => 'application/json',
      ],
    ]);
    
    $data = json_decode($response->getBody()->getContents(), TRUE);
    
    if (isset($data['objects'][0])) {
      $article_data = $data['objects'][0];
      
      // Update article fields with extracted data
      _news_extractor_update_article($entity, $article_data);
      
      // Log successful extraction
      \Drupal::logger('news_extractor')->info('Successfully extracted content for article: @title', [
        '@title' => $entity->getTitle(),
      ]);
    } else {
      \Drupal::logger('news_extractor')->warning('No article data returned from Diffbot for URL: @url', [
        '@url' => $url,
      ]);
    }
    
  } catch (\Exception $e) {
    \Drupal::logger('news_extractor')->error('Error extracting content from @url: @message', [
      '@url' => $url,
      '@message' => $e->getMessage(),
    ]);
  }
}

/**
 * Update article entity with extracted data from Diffbot.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   The article node entity.
 * @param array $article_data
 *   The article data from Diffbot API.
 */
function _news_extractor_update_article(EntityInterface $entity, array $article_data) {
  $updated = FALSE;
  
  // Update body with full article text
  if (!empty($article_data['text'])) {
    $entity->set('body', [
      'value' => $article_data['text'],
      'format' => 'basic_html',
    ]);
    $updated = TRUE;
    
    // Generate AI summary after setting the body content
    if ($entity->hasField('field_ai_summary')) {
      $summary = _news_extractor_generate_ai_summary(
        $article_data['text'], 
        $entity->getTitle()
      );
      
      if ($summary) {
        $entity->set('field_ai_summary', [
          'value' => $summary,
          'format' => 'basic_html',
        ]);
        $updated = TRUE;
        
        \Drupal::logger('news_extractor')->info('Generated AI summary for article: @title', [
          '@title' => $entity->getTitle(),
        ]);
      }
    }
  }
 
// Add bias rating based on news source
if ($entity->hasField('field_news_source') && !$entity->get('field_news_source')->isEmpty()) {
  $news_source = $entity->get('field_news_source')->value;
  $bias_data = _news_extractor_get_source_bias($news_source);
  
  // Set bias rating
  if ($entity->hasField('field_bias_rating')) {
    $entity->set('field_bias_rating', $bias_data['bias']);
    $updated = TRUE;
  }
  
  // Set credibility score
  if ($entity->hasField('field_credibility_score')) {
    $entity->set('field_credibility_score', $bias_data['credibility']);
    $updated = TRUE;
  }
  
  \Drupal::logger('news_extractor')->info('Applied bias rating @bias (credibility: @cred) to article from @source', [
    '@bias' => $bias_data['bias'],
    '@cred' => $bias_data['credibility'],
    '@source' => $news_source,
  ]);
}



 
  // Update author if available and field exists
  if (!empty($article_data['author']) && $entity->hasField('field_original_author')) {
    $entity->set('field_original_author', $article_data['author']);
    $updated = TRUE;
  }
  
  // Update publication date if available and field exists
  if (!empty($article_data['date']) && $entity->hasField('field_publication_date')) {
    try {
      $date = new \DateTime($article_data['date']);
      $entity->set('field_publication_date', $date->format('Y-m-d'));
      $updated = TRUE;
    } catch (\Exception $e) {
      \Drupal::logger('news_extractor')->warning('Invalid date format from Diffbot: @date', [
        '@date' => $article_data['date'],
      ]);
    }
  }
  
  // Add article hash for duplicate detection
  if ($entity->hasField('field_article_hash')) {
    $hash = md5($article_data['text'] ?? $entity->getTitle());
    $entity->set('field_article_hash', $hash);
    $updated = TRUE;
  }
  
  // Add tags if available
  if (!empty($article_data['tags']) && $entity->hasField('field_tags')) {
    $tag_ids = [];
    foreach ($article_data['tags'] as $tag) {
      $tag_id = _news_extractor_get_or_create_tag($tag['label']);
      if ($tag_id) {
        $tag_ids[] = $tag_id;
      }
    }
    if (!empty($tag_ids)) {
      $entity->set('field_tags', $tag_ids);
      $updated = TRUE;
    }
  }
  
  // When setting field_original_url_title, always truncate:
  if ($entity->hasField('field_original_url_title')) {
    $title_value = $item['title'];
    // Truncate to 255 characters for DB safety
    $title_value = substr($title_value, 0, 255);
    $entity->set('field_original_url_title', $title_value);
  }
  
  // Save the entity if any updates were made
  if ($updated) {
    $entity->save();
  }
}

/**
 * Generate AI summary using AWS Bedrock Claude.
 *
 * @param string $article_text
 *   The full article text.
 * @param string $article_title
 *   The article title.
 *
 * @return string|null
 *   The generated summary or NULL on failure.
 */
function _news_extractor_generate_ai_summary($article_text, $article_title) {
  try {
    $sdk = new \Aws\Sdk([
      'region' => 'us-west-2',
      'version' => 'latest',
    ]);
    
    $bedrock = $sdk->createBedrockRuntime();
    
    $prompt = "Please provide a neutral, analytical summary of this news article. Include:\n\n";
    $prompt .= "1. Key points (2-3 sentences)\n";
    $prompt .= "2. Main facts and any important quotes\n"; 
    $prompt .= "3. Brief analysis of significance\n\n";
    $prompt .= "Keep the summary to 2-3 paragraphs total.\n\n";
    $prompt .= "Article Title: " . $article_title . "\n\n";
    $prompt .= "Article Text: " . $article_text;
    
    $response = $bedrock->invokeModel([
//      'modelId' => 'anthropic.claude-3-5-sonnet-20241022-v2:0',
      'modelId' => 'anthropic.claude-3-5-sonnet-20240620-v1:0',
      'body' => json_encode([
        'anthropic_version' => 'bedrock-2023-05-31',
        'max_tokens' => 1000,
        'messages' => [
          [
            'role' => 'user',
            'content' => $prompt
          ]
        ]
      ])
    ]);
    
    $result = json_decode($response['body']->getContents(), true);
    
    if (isset($result['content'][0]['text'])) {
      return $result['content'][0]['text'];
    }
    
    return null;
    
  } catch (\Exception $e) {
    \Drupal::logger('news_extractor')->error('Error generating AI summary: @message', [
      '@message' => $e->getMessage(),
    ]);
    return null;
  }
}

/**
 * Get or create a taxonomy term for article tags.
 *
 * @param string $tag_name
 *   The tag name.
 *
 * @return int|null
 *   The taxonomy term ID, or NULL if creation failed.
 */
function _news_extractor_get_or_create_tag($tag_name) {
  $term_storage = \Drupal::entityTypeManager()->getStorage('taxonomy_term');
  
  // Search for existing term
  $terms = $term_storage->loadByProperties([
    'name' => $tag_name,
    'vid' => 'tags',
  ]);
  
  if (!empty($terms)) {
    $term = reset($terms);
    return $term->id();
  }
  
  // Create new term if it doesn't exist
  try {
    $term = $term_storage->create([
      'name' => $tag_name,
      'vid' => 'tags',
    ]);
    $term->save();
    return $term->id();
  } catch (\Exception $e) {
    \Drupal::logger('news_extractor')->error('Error creating tag @tag: @message', [
      '@tag' => $tag_name,
      '@message' => $e->getMessage(),
    ]);
    return NULL;
  }
}

/**
 * Implements hook_cron().
 *
 * Process any articles that might have failed extraction during cron runs.
 */
function news_extractor_cron() {
  // Find articles with Original URL but empty body (failed extractions)
  $query = \Drupal::entityQuery('node')
    ->condition('type', 'article')
    ->condition('field_original_url.uri', '', '<>')
    ->condition('body.value', '', '=')
    ->range(0, 10) // Process 10 at a time to avoid timeouts
    ->accessCheck(FALSE);
  
  $nids = $query->execute();
  
  if (!empty($nids)) {
    $nodes = Node::loadMultiple($nids);
    foreach ($nodes as $node) {
      $original_url = $node->get('field_original_url')->uri;
      _news_extractor_extract_content($node, $original_url);
    }
    
    \Drupal::logger('news_extractor')->info('Processed @count articles during cron run', [
      '@count' => count($nids),
    ]);
  }
}

/**
 * Get bias rating and credibility score for a news source.
 *
 * Based on AllSides Media Bias Chart and Media Bias/Fact Check ratings.
 *
 * @param string $source
 *   The news source name.
 *
 * @return array
 *   Array with 'bias' and 'credibility' keys.
 */
function _news_extractor_get_source_bias($source) {
  // Standardized bias ratings based on AllSides and MBFC
  $source_ratings = [
    // CNN Family
    'CNN Politics' => ['bias' => 'lean_left', 'credibility' => 75],
    'CNN' => ['bias' => 'lean_left', 'credibility' => 75],
    'CNN.com - RSS Channel - Politics' => ['bias' => 'lean_left', 'credibility' => 75],
    
    // Major News Sources (ready for when you add them)
    'NPR' => ['bias' => 'lean_left', 'credibility' => 85],
    'Reuters' => ['bias' => 'center', 'credibility' => 90],
    'Associated Press' => ['bias' => 'center', 'credibility' => 88],
    'BBC News' => ['bias' => 'center', 'credibility' => 82],
    'Wall Street Journal' => ['bias' => 'lean_right', 'credibility' => 80],
    'Fox News' => ['bias' => 'right', 'credibility' => 65],
    'MSNBC' => ['bias' => 'left', 'credibility' => 70],
    'New York Times' => ['bias' => 'lean_left', 'credibility' => 78],
    'Washington Post' => ['bias' => 'lean_left', 'credibility' => 77],
    'Politico' => ['bias' => 'lean_left', 'credibility' => 72],
    'The Hill' => ['bias' => 'center', 'credibility' => 70],
  ];
  
  // Default for unknown sources
  $default = ['bias' => 'center', 'credibility' => 50];
  
  return $source_ratings[$source] ?? $default;
}
