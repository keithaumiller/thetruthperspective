<?php
require_once __DIR__ . '/news_extractor.scraper.php';

/**
 * @file
 * News Extractor module - Extracts full article content using Diffbot API and generates AI summaries.
 */

use Drupal\node\Entity\Node;
use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_feeds_process_alter().
 * Alter feed item data before it becomes a node.
 */
function news_extractor_feeds_process_alter(&$feed, $item, $entity_interface) {
  // Debug: Log module version on every feed import
  \Drupal::logger('news_extractor')->info('news_extractor module version: 1.0.0 - feeds_process_alter triggered');

  // Only process Article content type
  if ($entity_interface->getTarget()->bundle() !== 'article') {
    return;
  }

  $title_to_check = $item['title'] ?? '';
  $link_to_check = $item['link'] ?? '';

  // Skip items with blocked strings
  if (_news_extractor_has_blocked_content($title_to_check, $link_to_check)) {
    $feed->skipItem($item);
    return;
  }

  // Skip items with invalid titles
  if (_news_extractor_has_invalid_title($title_to_check)) {
    $feed->skipItem($item);
    return;
  }

  // Skip non-article URLs
  if (!empty($item['link']) && !_news_extractor_is_article_url($item['link'])) {
    \Drupal::logger('news_extractor')->info('Skipping non-article URL: @url', [
      '@url' => $item['link'],
    ]);
    $feed->skipItem($item);
    return;
  }

  // --- Image linking logic ---
  // Check for image URL in feed item
  $image_url = $item['image'] ?? ($item['media:content'] ?? '');

  if (!empty($image_url) && filter_var($image_url, FILTER_VALIDATE_URL)) {
    // Store the image URL in the node's link field
    if ($entity_interface->getTarget()->hasField('field_external_image_url')) {
      $entity_interface->getTarget()->set('field_external_image_url', [
        'uri' => $image_url,
        'title' => $item['title'] ?? '',
      ]);
    }
  }
  // --- End image linking logic ---
}

/**
 * Implements hook_ENTITY_TYPE_insert().
 * Automatically extract full article content when a new article is created via feeds.
 */
function news_extractor_node_insert(EntityInterface $entity) {
  if ($entity->bundle() !== 'article') {
    return;
  }

  if (!$entity->hasField('field_original_url') || $entity->get('field_original_url')->isEmpty()) {
    return;
  }

  $original_url = $entity->get('field_original_url')->uri;

  // Delete non-article content
  if (!_news_extractor_is_article_url($original_url)) {
    \Drupal::logger('news_extractor')->info('Deleting non-article content: @title (@url)', [
      '@title' => $entity->getTitle(),
      '@url' => $original_url,
    ]);
    $entity->delete();
    return;
  }

  // Extract content if body is empty or too short
  $body = $entity->get('body')->value;
  if (empty($body) || strlen($body) < 500) {
    _news_extractor_extract_content($entity, $original_url);

    // --- Tagging logic ---
    // Get the Motivation Analysis from the entity
    $motivation_analysis = $entity->get('field_motivation_analysis')->value ?? '';
    if (!empty($motivation_analysis)) {
      $tags = _news_extractor_extract_tags_from_summary($motivation_analysis);
      
      // Create simple tags: entities + motivations + metrics
      $all_tags = array_merge($tags['entities'], $tags['motivations'], $tags['metrics']);
      
      $tag_ids = [];
      foreach ($all_tags as $tag) {
        $tid = _news_extractor_get_or_create_tag($tag);
        if ($tid) $tag_ids[] = $tid;
      }
      
      if (!empty($tag_ids)) {
        $entity->set('field_tags', $tag_ids);
        $entity->save();
      }

      // --- Linkify tags in Motivation Analysis ---
      // Load tag entities for linkifying
      $tag_entities = [];
      if (!empty($tag_ids)) {
        $tag_entities = \Drupal::entityTypeManager()->getStorage('taxonomy_term')->loadMultiple($tag_ids);
      }
      $motivation_analysis_linked = news_extractor_linkify_summary_tags($motivation_analysis, $tag_entities);
      $entity->set('field_motivation_analysis', [
        'value' => $motivation_analysis_linked,
        'format' => $entity->get('field_motivation_analysis')->format,
      ]);
      $entity->save();
      // --- End linkify ---
    }
    // --- End tagging logic ---
    // Post-process to fetch and set external image URL
    news_extractor_postprocess_article_image($entity);
  }
}

/**
 * Implements hook_ENTITY_TYPE_update().
 * Extract content when article is updated with new URL.
 */
function news_extractor_node_update(EntityInterface $entity) {
  if ($entity->bundle() !== 'article') {
    return;
  }

  if (!$entity->hasField('field_original_url') || $entity->get('field_original_url')->isEmpty()) {
    return;
  }

  $original_url = $entity->get('field_original_url')->uri;
  $original_entity = $entity->original;

  // Only extract if URL has changed
  if (!$original_entity->get('field_original_url')->isEmpty()) {
    $old_url = $original_entity->get('field_original_url')->uri;
    if ($original_url != $old_url) {
      _news_extractor_extract_content($entity, $original_url);
    }
  }
}

/**
 * Implements hook_cron().
 * Process any articles that might have failed extraction during cron runs.
 */
function news_extractor_cron() {
  $query = \Drupal::entityQuery('node')
    ->condition('type', 'article')
    ->condition('field_original_url.uri', '', '<>')
    ->condition('body.value', '', '=')
    ->range(0, 10)
    ->accessCheck(FALSE);

  $nids = $query->execute();

  if (!empty($nids)) {
    $nodes = Node::loadMultiple($nids);
    foreach ($nodes as $node) {
      $original_url = $node->get('field_original_url')->uri;
      _news_extractor_extract_content($node, $original_url);
    }
    \Drupal::logger('news_extractor')->info('Processed @count articles during cron run', [
      '@count' => count($nids),
    ]);
  }
}

/**
 * Generate AI summary using AWS Bedrock Claude.
 */
function _news_extractor_generate_ai_summary($article_text, $article_title) {
  try {
    $sdk = new \Aws\Sdk([
      'region' => 'us-west-2',
      'version' => 'latest',
    ]);
    $bedrock = $sdk->createBedrockRuntime();

    $prompt = _news_extractor_build_ai_prompt($article_title, $article_text);

    $response = $bedrock->invokeModel([
      'modelId' => 'anthropic.claude-3-5-sonnet-20240620-v1:0',
      'body' => json_encode([
        'anthropic_version' => 'bedrock-2023-05-31',
        'max_tokens' => 1000,
        'messages' => [
          [
            'role' => 'user',
            'content' => $prompt
          ]
        ]
      ])
    ]);

    $result = json_decode($response['body']->getContents(), true);

    if (isset($result['content'][0]['text'])) {
      return $result['content'][0]['text'];
    }
    return null;

  } catch (\Exception $e) {
    \Drupal::logger('news_extractor')->error('Error generating AI summary: @message', [
      '@message' => $e->getMessage(),
    ]);
    return null;
  }
}

/**
 * Get or create a taxonomy term for article tags.
 */
function _news_extractor_get_or_create_tag($tag_name) {
  $term_storage = \Drupal::entityTypeManager()->getStorage('taxonomy_term');
  $terms = $term_storage->loadByProperties([
    'name' => $tag_name,
    'vid' => 'tags',
  ]);

  if (!empty($terms)) {
    $term = reset($terms);
    return $term->id();
  }

  try {
    $term = $term_storage->create([
      'name' => $tag_name,
      'vid' => 'tags',
    ]);
    $term->save();
    return $term->id();
  } catch (\Exception $e) {
    \Drupal::logger('news_extractor')->error('Error creating tag @tag: @message', [
      '@tag' => $tag_name,
      '@message' => $e->getMessage(),
    ]);
    return NULL;
  }
}

/**
 * Get bias rating and credibility score for a news source.
 */
function _news_extractor_get_source_bias($source) {
  $source_ratings = [
    'CNN Politics' => ['bias' => 'lean_left', 'credibility' => 75],
    'CNN' => ['bias' => 'lean_left', 'credibility' => 75],
    'CNN.com - RSS Channel - Politics' => ['bias' => 'lean_left', 'credibility' => 75],
    'NPR' => ['bias' => 'lean_left', 'credibility' => 85],
    'Reuters' => ['bias' => 'center', 'credibility' => 90],
    'Associated Press' => ['bias' => 'center', 'credibility' => 88],
    'BBC News' => ['bias' => 'center', 'credibility' => 82],
    'Wall Street Journal' => ['bias' => 'lean_right', 'credibility' => 80],
    'Fox News' => ['bias' => 'right', 'credibility' => 65],
    'MSNBC' => ['bias' => 'left', 'credibility' => 70],
    'New York Times' => ['bias' => 'lean_left', 'credibility' => 78],
    'Washington Post' => ['bias' => 'lean_left', 'credibility' => 77],
    'Politico' => ['bias' => 'lean_left', 'credibility' => 72],
    'The Hill' => ['bias' => 'center', 'credibility' => 70],
  ];

  return $source_ratings[$source] ?? ['bias' => 'center', 'credibility' => 50];
}

/**
 * Helper function to check for blocked content in title and link.
 */
function _news_extractor_has_blocked_content($title, $link) {
  $blocked_strings = [
    'comparecards.com',
    'fool.com',
    'lendingtree.com',
  ];

  foreach ($blocked_strings as $str) {
    if (stripos($title, $str) !== FALSE) {
      \Drupal::logger('news_extractor')->info('Skipping blocked string in title: @title', [
        '@title' => $title,
      ]);
      return TRUE;
    }
    
    if (stripos($link, $str) !== FALSE) {
      \Drupal::logger('news_extractor')->info('Skipping blocked string in link: @url', [
        '@url' => $link,
      ]);
      return TRUE;
    }
  }

  return FALSE;
}

/**
 * Helper function to check for invalid titles.
 */
function _news_extractor_has_invalid_title($title) {
  // Skip items with missing or empty titles
  if (empty($title) || trim($title) == '') {
    \Drupal::logger('news_extractor')->info('Skipping item with missing or empty title');
    return TRUE;
  }

  // Skip items with very short titles
  if (strlen(trim($title)) < 10) {
    \Drupal::logger('news_extractor')->info('Skipping item with very short title: @title', [
      '@title' => $title,
    ]);
    return TRUE;
  }

  return FALSE;
}

/**
 * Returns the motivational category mapping based on thetruthperspective.org framework.
 * Key: Lowercase motivation string, Value: Motivational category.
 */
function _news_extractor_get_motivation_map() {
  static $motivation_map = [
    // Self-Determination Theory
    'joy' => 'Intrinsic Motivation',
    'happiness' => 'Intrinsic Motivation',
    'amusement' => 'Intrinsic Motivation',
    'bliss' => 'Intrinsic Motivation',
    'delight' => 'Intrinsic Motivation',
    'ecstasy' => 'Intrinsic Motivation',
    'enthusiasm' => 'Intrinsic Motivation',
    'excitement' => 'Intrinsic Motivation',
    'inspiration' => 'Intrinsic Motivation',
    'love' => 'Intrinsic Motivation',
    'wonder' => 'Intrinsic Motivation',
    'curiosity' => 'Intrinsic Motivation',
    'interest' => 'Intrinsic Motivation',
    'beauty appreciation' => 'Intrinsic Motivation',
    'elation' => 'External Regulation: Reward-seeking',
    'euphoria' => 'External Regulation: Reward-seeking',
    'triumph' => 'External Regulation: Reward-seeking',
    'anticipation' => 'External Regulation: Reward-seeking',
    'fear' => 'External Regulation: Punishment-avoidance',
    'anxiety' => 'External Regulation: Punishment-avoidance',
    'dread' => 'External Regulation: Punishment-avoidance',
    'panic' => 'External Regulation: Punishment-avoidance',
    'terror' => 'External Regulation: Punishment-avoidance',
    'worry' => 'External Regulation: Punishment-avoidance',
    'stress' => 'External Regulation: Deadline-driven',
    'tension' => 'External Regulation: Deadline-driven',
    'urgency' => 'External Regulation: Deadline-driven',
    'guilt' => 'Introjected Regulation: Guilt-based',
    'regret' => 'Introjected Regulation: Guilt-based',
    'remorse' => 'Introjected Regulation: Guilt-based',
    'pride' => 'Introjected Regulation: Ego-driven',
    'contempt' => 'Introjected Regulation: Ego-driven',
    'superiority' => 'Introjected Regulation: Ego-driven',
    'obligation' => 'Introjected Regulation: Should-based',
    'duty-bound feelings' => 'Introjected Regulation: Should-based',
    'hope' => 'Identified Regulation',
    'determination' => 'Identified Regulation',
    'resolve' => 'Identified Regulation',
    'serenity' => 'Integrated Regulation',
    'peace' => 'Integrated Regulation',
    'contentment' => 'Integrated Regulation',
    'authenticity' => 'Integrated Regulation',
    'boredom' => 'Amotivation',
    'apathy' => 'Amotivation',
    'dejection' => 'Amotivation',
    'depression' => 'Amotivation',
    'despair' => 'Amotivation',
    'melancholy' => 'Amotivation',
    'misery' => 'Amotivation',
    // Institutional Theory
    'obedience' => 'Compliance Motivation',
    'submission' => 'Compliance Motivation',
    'paranoia' => 'Deterrent Motivation',
    'wariness' => 'Deterrent Motivation',
    'greed' => 'Incentive Motivation',
    'ambition' => 'Incentive Motivation',
    'righteousness' => 'Moral Obligation',
    'moral outrage' => 'Moral Obligation',
    'indignation' => 'Moral Obligation',
    'elevation' => 'Moral Obligation',
    'embarrassment' => 'Social Expectation',
    'humiliation' => 'Social Expectation',
    'shame' => 'Social Expectation',
    'social anxiety' => 'Social Expectation',
    'professional pride' => 'Professional Duty',
    'duty' => 'Professional Duty',
    'gratitude' => 'Reciprocity Obligation',
    'indebtedness' => 'Reciprocity Obligation',
    'envy' => 'Mimetic Motivation',
    'jealousy' => 'Mimetic Motivation',
    'competitive spirit' => 'Mimetic Motivation',
    'dignity' => 'Identity-based Motivation',
    'honor' => 'Identity-based Motivation',
    'self-respect' => 'Identity-based Motivation',
    // Social Cognitive Theory
    'confidence' => 'Efficacy Expectations',
    'assurance' => 'Efficacy Expectations',
    'empowerment' => 'Efficacy Expectations',
    'capability' => 'Efficacy Expectations',
    'materialism' => 'Outcome Expectations',
    'acquisitiveness' => 'Outcome Expectations',
    'admiration-seeking' => 'Outcome Expectations',
    'approval-seeking' => 'Outcome Expectations',
    'self-satisfaction' => 'Outcome Expectations',
    'self-approval' => 'Outcome Expectations',
    'team spirit' => 'Collective Efficacy',
    'solidarity' => 'Collective Efficacy',
    'unity' => 'Collective Efficacy',
    'showing off' => 'Performance Goals',
    'demonstration pride' => 'Performance Goals',
    'performance anxiety' => 'Performance Goals',
    'fear of failure' => 'Performance Goals',
    'fascination' => 'Learning Goals',
    'intellectual excitement' => 'Learning Goals',
    'self-awareness' => 'Self-Monitoring',
    'mindfulness' => 'Self-Monitoring',
    'self-criticism' => 'Self-Evaluation',
    'self-assessment' => 'Self-Evaluation',
    'self-congratulation' => 'Self-Reaction',
    'self-appreciation' => 'Self-Reaction',
    'self-loathing' => 'Self-Reaction',
    'self-disappointment' => 'Self-Reaction',
    'modeling desire' => 'Observational Learning',
    'imitation urge' => 'Observational Learning',
    'encouragement' => 'Social Persuasion',
    'motivation from others' => 'Social Persuasion',
    'inspiration from others' => 'Vicarious Motivation',
    'aspirational feelings' => 'Vicarious Motivation',
    'cautionary feelings' => 'Vicarious Motivation',
    'warning emotions' => 'Vicarious Motivation',
    'exhilaration' => 'Emotional Arousal',
    'energized' => 'Emotional Arousal',
    'pumped up' => 'Emotional Arousal',
    'agitation' => 'Emotional Arousal',
    'restlessness' => 'Emotional Arousal',
    'irritation' => 'Emotional Arousal',
    'moodiness' => 'Mood-dependent Motivation',
    'emotional volatility' => 'Mood-dependent Motivation',
    'whimsical feelings' => 'Mood-dependent Motivation',
    'anticipated pleasure' => 'Anticipated Affect',
    'excitement about future' => 'Anticipated Affect',
    'preemptive guilt' => 'Anticipated Affect',
    'future-focused anxiety' => 'Anticipated Affect',
    'nostalgia' => 'Complex/Mixed Emotions',
    'bittersweet' => 'Complex/Mixed Emotions',
    'ambivalence' => 'Complex/Mixed Emotions',
    'poignancy' => 'Complex/Mixed Emotions',
  ];
  return $motivation_map;
}

/**
 * Motivational category mapping based on thetruthperspective.org framework.
 */
function _news_extractor_get_motivation_category($motivation) {
  $motivation_map = _news_extractor_get_motivation_map();
  $key = strtolower(trim($motivation));
  return $motivation_map[$key] ?? 'Other';
}

/**
 * Helper function to build AI prompt for social scientist perspective.
 */
function _news_extractor_build_ai_prompt($article_title, $article_text) {
  $allowed_motivations = "Ambition, Competitive spirit, Righteousness, Moral outrage, Loyalty, Pride, Determination, Fear, Greed, Power, Control, Revenge, Justice, Self-preservation, Recognition, Legacy, Influence, Security, Freedom, Unity, Professional pride, Duty, Curiosity, Enthusiasm, Wariness, Anxiety, Self-respect, Obligation, Indignation";

  return "Write this from the perspective of a social scientist that puts things in the context of key performance metrics of the United States.\n\n" .
         "Select the most appropriate key metric and speculate as a social scientist how the information in this article will affect that key performance metric.\n\n" .
         "For each entity mentioned in the article, identify their top 3 motivations from the allowed list below.\n\n" .
         "Only use motivations from this list: $allowed_motivations\n\n" .
         "Format your response EXACTLY as follows:\n\n" .
         "Entities mentioned:\n" .
         "- Entity Name: Motivation1, Motivation2, Motivation3\n" .
         "- Entity Name: Motivation1, Motivation2, Motivation3\n\n" .
         "Key metric: Metric Name\n\n" .
         "[Your analysis paragraph explaining how this will impact the key metric]\n\n" .
         "Article Title: " . $article_title . "\n\n" .
         "Article Text: " . $article_text;
}

/**
 * Extract entities, motivations, and metrics from the AI summary.
 */
function _news_extractor_extract_tags_from_summary($ai_summary) {
  $entities = [];
  $motivations = [];
  $metrics = [];

  // Extract entity-motivation pairings: "- Entity Name: Motivation1, Motivation2, Motivation3"
  if (preg_match('/Entities mentioned:(.*?)(?:Key metric:|$)/is', $ai_summary, $matches)) {
    foreach (preg_split('/\r?\n/', $matches[1]) as $line) {
      if (preg_match('/-\s*(.+?):\s*(.+)/', $line, $m)) {
        $entity_name = trim($m[1]);
        $entity_motivations = array_map('trim', explode(',', $m[2]));
        $entities[] = $entity_name;
        $motivations = array_merge($motivations, $entity_motivations);
      }
    }
  }

  // Key metric: single line after "Key metric:"
  if (preg_match('/Key metric:\s*(.+)/i', $ai_summary, $matches)) {
    $metrics[] = trim($matches[1]);
  }

  // Remove duplicates
  $entities = array_unique($entities);
  $motivations = array_unique($motivations);

  return [
    'entities' => $entities,
    'motivations' => $motivations,
    'metrics' => $metrics,
  ];
}

/**
 * Extract structured motivation data from AI summary for JSON field.
 */
function _news_extractor_extract_structured_data($motivation_analysis) {
  $data = [
    'entities' => [],
    'motivations' => [],
    'metrics' => []
  ];

  // Extract entities and their motivations
  if (preg_match('/Entities mentioned:(.*?)(?:Key metric:|$)/is', $motivation_analysis, $matches)) {
    foreach (preg_split('/\r?\n/', $matches[1]) as $line) {
      if (preg_match('/-\s*(.+?):\s*(.+)/', $line, $m)) {
        $entity = trim($m[1]);
        $motivations_text = trim($m[2]);
        $motivations = array_map('trim', explode(',', $motivations_text));
        
        $data['entities'][] = [
          'name' => $entity,
          'motivations' => $motivations
        ];
        
        // Also collect unique motivations
        foreach ($motivations as $motivation) {
          if (!empty($motivation) && !in_array($motivation, $data['motivations'])) {
            $data['motivations'][] = $motivation;
          }
        }
      }
    }
  }

  // Extract key metric
  if (preg_match('/Key metric:\s*(.+)/i', $motivation_analysis, $matches)) {
    $data['metrics'][] = trim($matches[1]);
  }

  return $data;
}

/**
 * Post-process article node to fetch and set external image URL from Diffbot.
 */
function news_extractor_postprocess_article_image(Node $node) {
  // Only process article nodes with an original URL.
  if ($node->bundle() !== 'article' || !$node->hasField('field_original_url')) {
    return;
  }

  $original_url = $node->get('field_original_url')->uri ?? '';
  if (empty($original_url)) {
    return;
  }

  // Get Diffbot token from config (set this in your module config).
  $diffbot_token = news_extractor_get_diffbot_token();
  if (empty($diffbot_token)) {
    \Drupal::logger('news_extractor')->error('Diffbot token not set in configuration.');
    return;
  }

  $api_url = 'https://api.diffbot.com/v3/article?token=' . urlencode($diffbot_token) . '&url=' . urlencode($original_url);

  try {
    $response = \Drupal::httpClient()->get($api_url, ['timeout' => 10]);
    $data = json_decode($response->getBody(), TRUE);

    // Check for images in the Diffbot response.
    if (!empty($data['objects'][0]['images']) && is_array($data['objects'][0]['images'])) {
      $first_image = $data['objects'][0]['images'][0]['url'] ?? '';
      if (!empty($first_image) && filter_var($first_image, FILTER_VALIDATE_URL)) {
        // Set the image URL in the node's field_external_image_url.
        if ($node->hasField('field_external_image_url')) {
          $node->set('field_external_image_url', [
            'uri' => $first_image,
            'title' => $node->getTitle(),
          ]);
          $node->save();
          \Drupal::logger('news_extractor')->info('Set external image URL for node @nid: @url', [
            '@nid' => $node->id(),
            '@url' => $first_image,
          ]);
        }
      }
    }
  } catch (\Exception $e) {
    \Drupal::logger('news_extractor')->error('Error fetching Diffbot image for node @nid: @msg', [
      '@nid' => $node->id(),
      '@msg' => $e->getMessage(),
    ]);
  }
}

/**
 * Helper to get the Diffbot API token from config.
 *
 * @return string
 *   The Diffbot API token, or an empty string if not set.
 */
function news_extractor_get_diffbot_token() {
  return \Drupal::config('news_extractor.settings')->get('diffbot_token') ?: '';
}

/**
 * Linkify tags in the AI summary.
 *
 * @param string $summary
 *   The AI summary text.
 * @param array $tags
 *   Array of taxonomy term entities or arrays with 'name' and 'tid'.
 * @return string
 *   The summary with tags linked.
 */
function news_extractor_linkify_summary_tags($summary, array $tags) {
  foreach ($tags as $tag) {
    // Get tag name and tid
    $tag_name = is_object($tag) ? $tag->getName() : $tag['name'];
    $tid = is_object($tag) ? $tag->id() : $tag['tid'];
    $url = '/taxonomy/term/' . $tid;
    // Replace only whole words, case-insensitive
    $summary = preg_replace_callback(
      '/\b(' . preg_quote($tag_name, '/') . ')\b/u',
      function ($matches) use ($url) {
        return '<a href="' . $url . '">' . $matches[1] . '</a>';
      },
      $summary
    );
  }
  return $summary;
}
